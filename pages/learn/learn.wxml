<view class="container">
  <!-- 学习设置（首次加载时显示） -->
  <view class="setup-modal" wx:if="{{showSetup}}">
    <view class="setup-content">
      <text class="setup-title">今天想学习多少个单词？</text>
      <view class="word-count-options">
        <button class="count-option" bindtap="selectWordCount" data-count="5">5个</button>
        <button class="count-option" bindtap="selectWordCount" data-count="10">10个</button>
        <button class="count-option" bindtap="selectWordCount" data-count="15">15个</button>
        <button class="count-option" bindtap="selectWordCount" data-count="20">20个</button>
      </view>
      <text class="setup-tip">建议每天学习10-15个新词</text>

      <!-- 来源标签筛选 -->
      <view class="source-filter" wx:if="{{availableTags.length > 0}}">
        <text class="filter-label">📚 学习来源：</text>
        <scroll-view scroll-x="true" class="tag-scroll">
          <view class="tag-options">
            <view class="tag-option {{selectedTag === '' ? 'active' : ''}}"
                  bindtap="selectSourceTag" data-tag="">
              全部来源
            </view>
            <view wx:for="{{availableTags}}" wx:key="index"
                  class="tag-option {{selectedTag === item ? 'active' : ''}}"
                  bindtap="selectSourceTag" data-tag="{{item}}">
              {{item}}
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- 自动开始选项 -->
      <view class="auto-start-option">
        <switch bindchange="toggleAutoStart" />
        <text>下次自动开始学习</text>
      </view>
    </view>
  </view>

  <!-- 来源标签筛选（主界面） -->
  <view class="main-source-filter" wx:if="{{!showSetup && availableTags.length > 0}}">
    <scroll-view scroll-x="true" class="tag-scroll-main">
      <view class="tag-options-main">
        <view class="tag-option-main {{selectedTag === '' ? 'active' : ''}}"
              bindtap="selectSourceTag" data-tag="">
          全部来源
        </view>
        <view wx:for="{{availableTags}}" wx:key="index"
              class="tag-option-main {{selectedTag === item ? 'active' : ''}}"
              bindtap="selectSourceTag" data-tag="{{item}}">
          {{item}}
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 学习进度 -->
  <view class="progress-header" wx:if="{{!showSetup}}">
    <text class="progress-text">{{currentIndex + 1}} / {{wordList.length}}</text>
    <view class="progress-dots">
      <view
        wx:for="{{wordList}}"
        wx:key="id"
        class="dot {{index <= currentIndex ? 'active' : ''}}"
      ></view>
    </view>
  </view>

  <!-- 单词卡片 -->
  <view class="word-card-wrapper">
    <view class="word-card" bindtap="playAudio">
      <view class="word-main">
        <text class="word-text">{{currentWord.word}}</text>
        <view class="word-kana">
          <text class="romaji">{{currentWord.romaji}}</text>
        </view>
      </view>
      
      <view class="divider"></view>
      
      <view class="word-meaning">
        <text class="meaning-text">{{currentWord.meaning}}</text>
        <view class="word-meta">
          <text class="word-type">{{currentWord.type}}</text>
          <text class="word-level">{{currentWord.level}}</text>
          <text class="word-source" wx:if="{{currentWord.source === 'history'}}">解析词汇</text>
        </view>
      </view>
      
      <!-- 例句部分 -->
      <view class="example-section" wx:if="{{currentWord.examples && currentWord.examples.length > 0}}">
        <text class="example-title">例句：</text>
        <view class="example-item" wx:for="{{currentWord.examples}}" wx:key="index">
          <text class="example-jp">{{item.jp}}</text>
          <text class="example-romaji" wx:if="{{item.romaji}}">{{item.romaji}}</text>
          <text class="example-cn">{{item.cn}}</text>
          
          <!-- 句子结构 -->
          <view class="example-structure" wx:if="{{item.structure}}">
            <text class="structure-label">结构：</text>
            <text class="structure-content">{{item.structure}}</text>
          </view>
          
          <!-- 语法分析 -->
          <view class="example-analysis" wx:if="{{item.analysis}}">
            <text class="analysis-label">分析：</text>
            <text class="analysis-content">{{item.analysis}}</text>
          </view>
          
          <view class="example-source" wx:if="{{item.source}}">
            <text class="source-label">出处：{{item.source}}</text>
          </view>
        </view>
        
        <!-- 语法信息 -->
        <view wx:if="{{currentWord.grammar || currentWord.structure || currentWord.analysis}}" class="grammar-section">
          <view wx:if="{{currentWord.structure}}" class="grammar-item">
            <text class="grammar-label">句子结构：</text>
            <text class="grammar-content">{{currentWord.structure}}</text>
          </view>
          
          <view wx:if="{{currentWord.grammar}}" class="grammar-item">
            <text class="grammar-label">语法要点：</text>
            <text class="grammar-content">{{currentWord.grammar}}</text>
          </view>
          
          <view wx:if="{{currentWord.analysis}}" class="grammar-item">
            <text class="grammar-label">详细解析：</text>
            <text class="grammar-content">{{currentWord.analysis}}</text>
          </view>
        </view>
      </view>
      
      <!-- 无例句提示 -->
      <view class="example-section" wx:if="{{!currentWord.examples || currentWord.examples.length === 0}}">
        <text class="example-title">例句：</text>
        <text class="no-example-hint">暂无例句</text>
        <view class="add-example-hint">
          <text>💡 去</text>
          <text class="link-text" bindtap="goToParser">日语解析</text>
          <text>页面输入包含此词的句子，系统会自动关联例句</text>
        </view>
      </view>
      
      <view class="audio-hint">
        <text>🔊 点击卡片播放语音</text>
      </view>
    </view>
  </view>

  <!-- 翻页按钮 -->
  <view class="nav-buttons">
    <button class="btn-nav" bindtap="prevWord" disabled="{{currentIndex === 0}}">
      上一个
    </button>
    <button class="btn-nav" bindtap="nextWord" disabled="{{currentIndex >= wordList.length - 1}}">
      下一个
    </button>
  </view>

  <!-- 操作按钮 -->
  <view class="action-buttons">
    <button class="btn-action" bindtap="toggleExample">
      {{showExample ? '隐藏例句' : '显示例句'}}
    </button>
  </view>

  <!-- 学习进度和确认按钮 -->
  <view class="learning-progress-section">
    <!-- 学习进度显示 -->
    <view class="learning-stats">
      <view class="stat-item">
        <text class="stat-icon">📚</text>
        <text class="stat-text">本轮学习 {{currentWord.sessionCount || 0}} 次</text>
      </view>
      <view class="stat-item">
        <text class="stat-icon">✅</text>
        <text class="stat-text">累计学习 {{currentWord.learningCount || 0}} 次</text>
      </view>
    </view>

    <!-- 学习操作按钮 -->
    <view class="learning-action-buttons">
      <!-- 未掌握时显示学习按钮 -->
      <block wx:if="{{!currentWord.masteryConfirmed}}">
        <button class="btn-continue" bindtap="continueLearning">
          <text class="btn-icon">➕</text>
          <text>+1学习</text>
        </button>
        <button
          class="btn-confirm-master {{canConfirmMastery ? 'active' : 'disabled'}}"
          bindtap="confirmMastery"
          disabled="{{!canConfirmMastery}}">
          <text class="btn-icon">{{canConfirmMastery ? '🎯' : '🔒'}}</text>
          <text>{{canConfirmMastery ? '确认已掌握' : '需学习' + requiredLearningCount + '次'}}</text>
        </button>
      </block>

      <!-- 已掌握时显示状态 -->
      <view class="mastered-container" wx:else>
        <view class="mastered-status">
          <text class="mastered-icon">✅</text>
          <text class="mastered-text">已掌握此单词</text>
          <text class="mastered-count">（累计学习 {{currentWord.learningCount || 0}} 次）</text>
        </view>
        <button class="btn-reset-mastery" bindtap="resetMastery">
          <text class="btn-icon">🔄</text>
          <text>重置为未掌握</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 完成提示 -->
  <view class="complete-modal" wx:if="{{showComplete}}">
    <view class="modal-content">
      <text class="complete-title">🎉 本轮学习完成！</text>
      <text class="complete-desc">你已学习了 {{wordList.length}} 个单词</text>
      <view class="complete-stats">
        <view class="stat-item">
          <text class="stat-label">学习次数</text>
          <text class="stat-value">{{totalLearningCount}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">确认掌握</text>
          <text class="stat-value">{{masteredCount}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">待复习</text>
          <text class="stat-value">{{wordList.length - masteredCount}}</text>
        </view>
      </view>
      <view class="complete-buttons">
        <button class="btn-secondary" bindtap="learnMore">继续学习</button>
        <button class="btn-primary" bindtap="goBack">结束学习</button>
      </view>
    </view>
  </view>
</view>