<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar" wx:if="{{!currentLesson}}">
    <input 
      class="search-input"
      placeholder="æœç´¢è¯­æ³•åç§°ã€å¥å‹æˆ–è¯´æ˜"
      value="{{searchKeyword}}"
      bindinput="onSearchInput"
    />
    <icon type="search" size="20" color="#999" />
  </view>

  <!-- è¿›åº¦ç»Ÿè®¡ -->
  <view class="progress-stats" wx:if="{{!currentLesson}}">
    <view class="stats-item">
      <text class="stats-label">æ€»è¯¾ç¨‹</text>
      <text class="stats-value">{{totalLessons}}</text>
    </view>
    <view class="stats-item">
      <text class="stats-label">å·²å®Œæˆ</text>
      <text class="stats-value">{{studyProgress.completedLessons.length || 0}}</text>
    </view>
    <view class="stats-item">
      <text class="stats-label">å·²æŒæ¡</text>
      <text class="stats-value">{{studyProgress.masteredLessons.length || 0}}</text>
    </view>
    <view class="stats-item">
      <text class="stats-label">æ”¶è—</text>
      <text class="stats-value">{{favoriteIds.length}}</text>
    </view>
  </view>

  <!-- è¯­æ³•åˆ—è¡¨ -->
  <view class="grammar-list" wx:if="{{!currentLesson}}">
    <block wx:for="{{filteredUnits}}" wx:key="key">
      <view class="unit-section">
        <view class="unit-header" bindtap="toggleUnit" data-key="{{item.key}}">
          <text class="unit-title">{{item.title}}</text>
          <text class="unit-count">{{item.lessons.length}}è¯¾</text>
          <text class="expand-icon">{{expandedUnits[item.key] ? 'â–¼' : 'â–¶'}}</text>
        </view>
        
        <view class="lesson-list" wx:if="{{expandedUnits[item.key]}}">
          <view 
            class="lesson-item"
            wx:for="{{item.lessons}}" 
            wx:for-item="lesson"
            wx:key="id"
            bindtap="viewLesson"
            data-lesson="{{lesson}}"
          >
            <view class="lesson-main">
              <text class="lesson-title">{{lesson.title}}</text>
              <text class="lesson-grammar">{{lesson.grammar}}</text>
              <text class="lesson-explain">{{lesson.explanation}}</text>
            </view>
            <view class="lesson-tags">
              <text wx:if="{{favoriteIds.includes(lesson.id)}}" class="tag favorite">â˜…</text>
              <text wx:if="{{studyProgress.masteredLessons.includes(lesson.id)}}" class="tag mastered">å·²æŒæ¡</text>
              <text wx:elif="{{studyProgress.completedLessons.includes(lesson.id)}}" class="tag completed">å·²å­¦ä¹ </text>
              <text wx:else class="tag new">æœªå­¦ä¹ </text>
            </view>
          </view>
        </view>
      </view>
    </block>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{!currentLesson && filteredUnits.length === 0}}">
    <text>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯­æ³•</text>
  </view>

  <!-- è¯¾ç¨‹è¯¦æƒ… -->
  <view class="lesson-detail" wx:if="{{currentLesson && !practiceMode}}">
    <!-- è¿”å›æŒ‰é’® -->
    <view class="back-header">
      <text class="back-btn" bindtap="backToList">â† è¿”å›åˆ—è¡¨</text>
      <view class="action-buttons">
        <text 
          class="action-btn {{favoriteIds.includes(currentLesson.id) ? 'favorited' : ''}}"
          bindtap="toggleFavorite"
        >
          {{favoriteIds.includes(currentLesson.id) ? 'â˜… å·²æ”¶è—' : 'â˜† æ”¶è—'}}
        </text>
        <text 
          class="action-btn"
          bindtap="markAsMastered"
          wx:if="{{!studyProgress.masteredLessons.includes(currentLesson.id)}}"
        >
          æ ‡è®°æŒæ¡
        </text>
      </view>
    </view>

    <!-- è¯­æ³•æ ‡é¢˜ -->
    <view class="detail-header">
      <text class="detail-unit">{{currentLesson.unitTitle}}</text>
      <text class="detail-title">{{currentLesson.title}}</text>
      <text class="detail-level">{{currentLesson.level}}</text>
    </view>

    <!-- è¯­æ³•è¯´æ˜ -->
    <view class="grammar-section">
      <text class="section-title">å¥å‹</text>
      <text class="grammar-pattern">{{currentLesson.grammar}}</text>
    </view>

    <view class="explanation-section">
      <text class="section-title">è¯´æ˜</text>
      <text class="explanation-text">{{currentLesson.explanation}}</text>
    </view>

    <!-- ä¾‹å¥ -->
    <view class="examples-section">
      <text class="section-title">ä¾‹å¥ ({{currentLesson.examples.length}})</text>
      <view class="example-list">
        <view class="example-item" wx:for="{{currentLesson.examples}}" wx:key="index">
          <view class="example-header">
            <text class="example-number">ä¾‹{{index + 1}}</text>
            <text class="play-btn" bindtap="playExample" data-text="{{item.jp}}">ğŸ”Š</text>
          </view>
          <text class="example-jp">{{item.jp}}</text>
          <text class="example-kana">{{item.kana}}</text>
          <text class="example-romaji">{{item.romaji}}</text>
          <text class="example-cn">{{item.cn}}</text>
          <text class="example-grammar" wx:if="{{item.grammar}}">å¥å‹åˆ†æï¼š{{item.grammar}}</text>
        </view>
      </view>
    </view>

    <!-- å¼€å§‹ç»ƒä¹ æŒ‰é’® -->
    <button class="practice-btn" bindtap="startPractice">å¼€å§‹ç»ƒä¹ </button>
  </view>

  <!-- ç»ƒä¹ æ¨¡å¼ -->
  <view class="practice-mode" wx:if="{{practiceMode}}">
    <view class="practice-header">
      <text class="practice-title">{{currentLesson.title}} - ç»ƒä¹ </text>
      <text class="practice-progress">{{currentExampleIndex + 1}} / {{practiceExamples.length}}</text>
    </view>

    <view class="practice-content">
      <!-- å¡«ç©ºé¢˜ -->
      <block wx:if="{{practiceExamples[currentExampleIndex].type === 'fill'}}">
        <text class="practice-question">{{practiceExamples[currentExampleIndex].question}}</text>
        <input 
          class="answer-input"
          placeholder="è¯·è¾“å…¥ç­”æ¡ˆ"
          value="{{userAnswer}}"
          bindinput="onAnswerInput"
        />
      </block>

      <!-- ç¿»è¯‘é¢˜ -->
      <block wx:if="{{practiceExamples[currentExampleIndex].type === 'translate'}}">
        <text class="practice-instruction">è¯·ç¿»è¯‘ä»¥ä¸‹å¥å­ï¼š</text>
        <text class="practice-jp">{{practiceExamples[currentExampleIndex].jp}}</text>
        <text class="practice-kana" wx:if="{{practiceExamples[currentExampleIndex].kana}}">
          {{practiceExamples[currentExampleIndex].kana}}
        </text>
      </block>

      <!-- æ˜¾ç¤ºç­”æ¡ˆ -->
      <view class="answer-section" wx:if="{{showAnswer}}">
        <text class="answer-label">æ­£ç¡®ç­”æ¡ˆï¼š</text>
        <text class="answer-text">{{practiceExamples[currentExampleIndex].answer || practiceExamples[currentExampleIndex].cn}}</text>
        <text class="answer-result {{isCorrect ? 'correct' : 'incorrect'}}">
          {{isCorrect ? 'âœ“ å›ç­”æ­£ç¡®ï¼' : 'âœ— å›ç­”é”™è¯¯'}}
        </text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="practice-actions">
        <button 
          wx:if="{{!showAnswer}}" 
          class="check-btn"
          bindtap="checkAnswer"
        >
          æ£€æŸ¥ç­”æ¡ˆ
        </button>
        <button 
          wx:if="{{showAnswer}}" 
          class="next-btn"
          bindtap="nextExample"
        >
          {{currentExampleIndex < practiceExamples.length - 1 ? 'ä¸‹ä¸€é¢˜' : 'å®Œæˆç»ƒä¹ '}}
        </button>
      </view>
    </view>
  </view>
</view>