<!-- pages/mastery-stats/mastery-stats.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <view class="header">
    <view class="header-left" bindtap="onBack">
      <text class="back-btn">â†</text>
    </view>
    <view class="header-title">å­¦ä¹ è¿›åº¦</view>
    <view class="header-right"></view>
  </view>

  <!-- ç»Ÿè®¡æ¨¡å¼åˆ‡æ¢ -->
  <view class="mode-switch">
    <view class="switch-item {{statsMode === 'behavior' ? 'active' : ''}}" bindtap="switchStatsMode" data-mode="behavior">
      ğŸ“Š å­¦ä¹ è¡Œä¸º
    </view>
    <view class="switch-item {{statsMode === 'mastery' ? 'active' : ''}}" bindtap="switchStatsMode" data-mode="mastery">
      ğŸ“ æŒæ¡ç¨‹åº¦
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading-container">
    <text class="loading-text">ç»Ÿè®¡è®¡ç®—ä¸­...</text>
  </view>

  <!-- ç»Ÿè®¡å†…å®¹ -->
  <view wx:else class="stats-content">
    
    <!-- å­¦ä¹ è¡Œä¸ºç»Ÿè®¡ -->
    <view wx:if="{{statsMode === 'behavior'}}" class="behavior-stats-content">
      <!-- æ€»ä½“æ•°æ®æ¦‚è§ˆ -->
      <view class="behavior-overview-card">
        <view class="overview-title">ğŸ“ˆ æœ€è¿‘7å¤©å­¦ä¹ æ•°æ®</view>
        <view class="overview-grid">
          <view class="overview-item">
            <text class="overview-number">{{learningBehaviorStats.totalViewed}}</text>
            <text class="overview-label">æŸ¥çœ‹æ¬¡æ•°</text>
          </view>
          <view class="overview-item">
            <text class="overview-number">{{learningBehaviorStats.totalStudied}}</text>
            <text class="overview-label">å­¦ä¹ æ¬¡æ•°</text>
          </view>
          <view class="overview-item">
            <text class="overview-number">{{learningBehaviorStats.totalReviewed}}</text>
            <text class="overview-label">å¤ä¹ æ¬¡æ•°</text>
          </view>
          <view class="overview-item">
            <text class="overview-number">{{learningBehaviorStats.uniqueContentCount}}</text>
            <text class="overview-label">æ¶‰åŠå†…å®¹</text>
          </view>
        </view>
      </view>

      <!-- å­¦ä¹ ä¹ æƒ¯ç»Ÿè®¡ -->
      <view class="study-habits-card">
        <view class="stat-header">
          <text class="stat-title">ğŸ“… å­¦ä¹ ä¹ æƒ¯</text>
        </view>
        <view class="habits-grid">
          <view class="habit-item">
            <text class="habit-label">å­¦ä¹ å¤©æ•°</text>
            <text class="habit-value">{{learningBehaviorStats.studyDays}} å¤©</text>
          </view>
          <view class="habit-item">
            <text class="habit-label">æ—¥å‡å­¦ä¹ </text>
            <text class="habit-value">{{learningBehaviorStats.avgDailyActions}} æ¬¡</text>
          </view>
        </view>
      </view>

      <!-- å†…å®¹ç±»å‹åˆ†è§£ -->
      <view class="content-breakdown-card">
        <view class="stat-header">
          <text class="stat-title">ğŸ“š å†…å®¹å­¦ä¹ åˆ†è§£</text>
        </view>
        
        <!-- å¥å­å­¦ä¹  -->
        <view class="breakdown-item">
          <view class="breakdown-header">
            <text class="breakdown-title">ğŸ“ å¥å­</text>
            <text class="breakdown-total">æ€»è®¡ï¼š{{learningBehaviorStats.contentBreakdown.sentence.viewed + learningBehaviorStats.contentBreakdown.sentence.studied + learningBehaviorStats.contentBreakdown.sentence.reviewed}}</text>
          </view>
          <view class="breakdown-details">
            <text class="detail-item">æŸ¥çœ‹ {{learningBehaviorStats.contentBreakdown.sentence.viewed}}</text>
            <text class="detail-item">å­¦ä¹  {{learningBehaviorStats.contentBreakdown.sentence.studied}}</text>
            <text class="detail-item">å¤ä¹  {{learningBehaviorStats.contentBreakdown.sentence.reviewed}}</text>
          </view>
        </view>

        <!-- è¯æ±‡å­¦ä¹  -->
        <view class="breakdown-item">
          <view class="breakdown-header">
            <text class="breakdown-title">ğŸ“š è¯æ±‡</text>
            <text class="breakdown-total">æ€»è®¡ï¼š{{learningBehaviorStats.contentBreakdown.word.viewed + learningBehaviorStats.contentBreakdown.word.studied + learningBehaviorStats.contentBreakdown.word.reviewed}}</text>
          </view>
          <view class="breakdown-details">
            <text class="detail-item">æŸ¥çœ‹ {{learningBehaviorStats.contentBreakdown.word.viewed}}</text>
            <text class="detail-item">å­¦ä¹  {{learningBehaviorStats.contentBreakdown.word.studied}}</text>
            <text class="detail-item">å¤ä¹  {{learningBehaviorStats.contentBreakdown.word.reviewed}}</text>
          </view>
        </view>

        <!-- è¯­æ³•å­¦ä¹  -->
        <view class="breakdown-item">
          <view class="breakdown-header">
            <text class="breakdown-title">ğŸ” è¯­æ³•</text>
            <text class="breakdown-total">æ€»è®¡ï¼š{{learningBehaviorStats.contentBreakdown.grammar.viewed + learningBehaviorStats.contentBreakdown.grammar.studied + learningBehaviorStats.contentBreakdown.grammar.reviewed}}</text>
          </view>
          <view class="breakdown-details">
            <text class="detail-item">æŸ¥çœ‹ {{learningBehaviorStats.contentBreakdown.grammar.viewed}}</text>
            <text class="detail-item">å­¦ä¹  {{learningBehaviorStats.contentBreakdown.grammar.studied}}</text>
            <text class="detail-item">å¤ä¹  {{learningBehaviorStats.contentBreakdown.grammar.reviewed}}</text>
          </view>
        </view>
      </view>

      <!-- æ¯æ—¥æ´»åŠ¨è¶‹åŠ¿ -->
      <view wx:if="{{learningBehaviorStats.dailyActivity.length > 0}}" class="daily-activity-card">
        <view class="stat-header">
          <text class="stat-title">ğŸ“Š æ¯æ—¥å­¦ä¹ è¶‹åŠ¿</text>
        </view>
        <view class="activity-chart">
          <view wx:for="{{learningBehaviorStats.dailyActivity}}" wx:key="date" class="activity-day">
            <view class="activity-bar" style="height: {{item.actions * 2}}px; max-height: 100px;"></view>
            <text class="activity-date">{{item.date.split('-')[2]}}</text>
            <text class="activity-count">{{item.actions}}</text>
          </view>
        </view>
      </view>

      <!-- å¤ä¹ ä¸“é¡¹ç»Ÿè®¡ -->
      <view class="review-stats-card">
        <view class="stat-header">
          <text class="stat-title">ğŸ”„ å¤ä¹ ä¸“é¡¹åˆ†æ</text>
        </view>
        
        <!-- å¤ä¹ æ¦‚è§ˆ -->
        <view class="review-overview">
          <view class="review-item">
            <text class="review-label">å¤ä¹ æ€»æ¬¡æ•°</text>
            <text class="review-value">{{reviewStats.totalReviews}}</text>
          </view>
          <view class="review-item">
            <text class="review-label">å¤ä¹ å†…å®¹æ•°</text>
            <text class="review-value">{{reviewStats.reviewedContentCount}}</text>
          </view>
          <view class="review-item">
            <text class="review-label">å¤ä¹ å¤©æ•°</text>
            <text class="review-value">{{reviewStats.consistentDays}}</text>
          </view>
        </view>

        <!-- å¤ä¹ æ—¶é—´åå¥½ -->
        <view wx:if="{{reviewStats.reviewPatterns.byTimeOfDay}}" class="review-patterns">
          <text class="pattern-title">â° å¤ä¹ æ—¶é—´åå¥½</text>
          <view class="time-patterns">
            <view wx:if="{{reviewStats.reviewPatterns.byTimeOfDay.morning}}" class="time-item">
              <text class="time-label">ğŸŒ… ä¸Šåˆ</text>
              <text class="time-count">{{reviewStats.reviewPatterns.byTimeOfDay.morning}}æ¬¡</text>
            </view>
            <view wx:if="{{reviewStats.reviewPatterns.byTimeOfDay.afternoon}}" class="time-item">
              <text class="time-label">â˜€ï¸ ä¸‹åˆ</text>
              <text class="time-count">{{reviewStats.reviewPatterns.byTimeOfDay.afternoon}}æ¬¡</text>
            </view>
            <view wx:if="{{reviewStats.reviewPatterns.byTimeOfDay.evening}}" class="time-item">
              <text class="time-label">ğŸŒ™ æ™šä¸Š</text>
              <text class="time-count">{{reviewStats.reviewPatterns.byTimeOfDay.evening}}æ¬¡</text>
            </view>
          </view>
        </view>

        <!-- å¤ä¹ å†…å®¹åå¥½ -->
        <view wx:if="{{reviewStats.reviewPatterns.byContentType}}" class="content-patterns">
          <text class="pattern-title">ğŸ“š å¤ä¹ å†…å®¹åå¥½</text>
          <view class="content-types">
            <view wx:if="{{reviewStats.reviewPatterns.byContentType.sentence}}" class="content-type-item">
              <text class="content-type-label">ğŸ“ å¥å­</text>
              <text class="content-type-count">{{reviewStats.reviewPatterns.byContentType.sentence}}æ¬¡</text>
            </view>
            <view wx:if="{{reviewStats.reviewPatterns.byContentType.word}}" class="content-type-item">
              <text class="content-type-label">ğŸ“š è¯æ±‡</text>
              <text class="content-type-count">{{reviewStats.reviewPatterns.byContentType.word}}æ¬¡</text>
            </view>
            <view wx:if="{{reviewStats.reviewPatterns.byContentType.grammar}}" class="content-type-item">
              <text class="content-type-label">ğŸ” è¯­æ³•</text>
              <text class="content-type-count">{{reviewStats.reviewPatterns.byContentType.grammar}}æ¬¡</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å­¦ä¹ å»ºè®® -->
      <view class="behavior-suggestion-card">
        <view class="suggestion-title">ğŸ’¡ å­¦ä¹ å»ºè®®</view>
        <view class="suggestion-content">
          <view wx:if="{{learningBehaviorStats.studyDays < 3}}" class="suggestion-item">
            <text class="suggestion-icon">ğŸ“…</text>
            <text class="suggestion-text">å»ºè®®æ¯å¤©åšæŒå­¦ä¹ ï¼ŒåŸ¹å…»å­¦ä¹ ä¹ æƒ¯</text>
          </view>
          <view wx:if="{{learningBehaviorStats.totalReviewed < learningBehaviorStats.totalStudied / 3}}" class="suggestion-item">
            <text class="suggestion-icon">ğŸ”„</text>
            <text class="suggestion-text">å¯ä»¥å¢åŠ å¤ä¹ é¢‘ç‡ï¼Œå·©å›ºå­¦ä¹ æ•ˆæœ</text>
          </view>
          <view wx:if="{{reviewStats.totalReviews === 0}}" class="suggestion-item">
            <text class="suggestion-icon">ğŸ“–</text>
            <text class="suggestion-text">å°è¯•ä½¿ç”¨å¤ä¹ åŠŸèƒ½ï¼Œå·©å›ºå·²å­¦å†…å®¹</text>
          </view>
          <view wx:if="{{reviewStats.consistentDays >= 5}}" class="suggestion-item success">
            <text class="suggestion-icon">ğŸ†</text>
            <text class="suggestion-text">å¤ä¹ ä¹ æƒ¯å¾ˆæ£’ï¼æŒç»­å¤ä¹ æ•ˆæœæ›´ä½³</text>
          </view>
          <view wx:if="{{learningBehaviorStats.avgDailyActions < 10}}" class="suggestion-item">
            <text class="suggestion-icon">ğŸ“ˆ</text>
            <text class="suggestion-text">å»ºè®®é€‚å½“å¢åŠ æ¯æ—¥å­¦ä¹ é‡</text>
          </view>
          <view wx:if="{{learningBehaviorStats.studyDays >= 7 && learningBehaviorStats.avgDailyActions >= 20}}" class="suggestion-item success">
            <text class="suggestion-icon">ğŸ‰</text>
            <text class="suggestion-text">å­¦ä¹ ä¹ æƒ¯éå¸¸å¥½ï¼ç»§ç»­ä¿æŒ</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æŒæ¡ç¨‹åº¦ç»Ÿè®¡ï¼ˆåŸæœ‰å†…å®¹ï¼‰ -->
    <view wx:else class="mastery-stats-content">
    <!-- ç­›é€‰æ  -->
    <view class="filter-bar">
      <view class="filter-item {{filterType === 'all' ? 'active' : ''}}" bindtap="onFilterChange" data-type="all">
        å…¨éƒ¨è®°å½•
      </view>
      <view class="filter-item {{filterType === 'favorite' ? 'active' : ''}}" bindtap="onFilterChange" data-type="favorite">
        æ”¶è—è®°å½•
      </view>
      <view class="filter-item {{filterType === 'recent' ? 'active' : ''}}" bindtap="onFilterChange" data-type="recent">
        æœ€è¿‘7å¤©
      </view>
    </view>

    <!-- æ€»ä½“æ¦‚è§ˆ -->
    <view class="overview-card">
      <view class="overview-title">ğŸ“Š æ€»ä½“æŒæ¡æƒ…å†µ</view>
      <view class="overview-grid">
        <view class="overview-item">
          <text class="overview-number">{{totalStats.sentence.total}}</text>
          <text class="overview-label">å¥å­æ€»æ•°</text>
        </view>
        <view class="overview-item">
          <text class="overview-number">{{totalStats.word.total}}</text>
          <text class="overview-label">è¯æ±‡æ€»æ•°</text>
        </view>
        <view class="overview-item">
          <text class="overview-number">{{totalStats.analysis.total}}</text>
          <text class="overview-label">è¯­æ³•ç‚¹æ€»æ•°</text>
        </view>
        <view class="overview-item">
          <text class="overview-number">{{totalStats.sentence.mastered + totalStats.word.mastered + totalStats.analysis.mastered}}</text>
          <text class="overview-label">å·²æŒæ¡é¡¹ç›®</text>
        </view>
      </view>
    </view>

    <!-- åˆ†ç±»ç»Ÿè®¡ -->
    <view class="category-stats">
      <!-- å¥å­æŒæ¡åº¦ -->
      <view class="stat-card">
        <view class="stat-header">
          <text class="stat-title">ğŸ“ å¥å­æŒæ¡æƒ…å†µ</text>
          <text class="stat-total">({{totalStats.sentence.total}}ä¸ª)</text>
        </view>
        <view class="stat-bar">
          <view class="bar-segment mastered" style="width: {{totalStats.sentence.masteredPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{totalStats.sentence.partialPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{totalStats.sentence.unfamiliarPercent}}%"></view>
          <view class="bar-segment unseen" style="width: {{totalStats.sentence.unseenPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <view class="legend-item mastered">
            <view class="legend-dot"></view>
            <text>å·²æŒæ¡ {{totalStats.sentence.mastered}}</text>
          </view>
          <view class="legend-item partial">
            <view class="legend-dot"></view>
            <text>ç•¥æ‡‚ {{totalStats.sentence.partial}}</text>
          </view>
          <view class="legend-item unfamiliar">
            <view class="legend-dot"></view>
            <text>æœªæŒæ¡ {{totalStats.sentence.unfamiliar}}</text>
          </view>
          <view class="legend-item unseen">
            <view class="legend-dot"></view>
            <text>æœªçœ‹ {{totalStats.sentence.unseen}}</text>
          </view>
        </view>
      </view>

      <!-- è¯æ±‡æŒæ¡åº¦ -->
      <view class="stat-card">
        <view class="stat-header">
          <text class="stat-title">ğŸ“š è¯æ±‡æŒæ¡æƒ…å†µ</text>
          <text class="stat-total">({{totalStats.word.total}}ä¸ª)</text>
        </view>
        <view class="stat-bar">
          <view class="bar-segment mastered" style="width: {{totalStats.word.masteredPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{totalStats.word.partialPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{totalStats.word.unfamiliarPercent}}%"></view>
          <view class="bar-segment unseen" style="width: {{totalStats.word.unseenPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <view class="legend-item mastered">
            <view class="legend-dot"></view>
            <text>å·²æŒæ¡ {{totalStats.word.mastered}}</text>
          </view>
          <view class="legend-item partial">
            <view class="legend-dot"></view>
            <text>ç•¥æ‡‚ {{totalStats.word.partial}}</text>
          </view>
          <view class="legend-item unfamiliar">
            <view class="legend-dot"></view>
            <text>æœªæŒæ¡ {{totalStats.word.unfamiliar}}</text>
          </view>
          <view class="legend-item unseen">
            <view class="legend-dot"></view>
            <text>æœªçœ‹ {{totalStats.word.unseen}}</text>
          </view>
        </view>
      </view>

      <!-- è¯­æ³•åˆ†ææŒæ¡åº¦ -->
      <view class="stat-card">
        <view class="stat-header">
          <text class="stat-title">ğŸ” è¯­æ³•åˆ†ææŒæ¡æƒ…å†µ</text>
          <text class="stat-total">({{totalStats.analysis.total}}ä¸ª)</text>
        </view>
        <view class="stat-bar">
          <view class="bar-segment mastered" style="width: {{totalStats.analysis.masteredPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{totalStats.analysis.partialPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{totalStats.analysis.unfamiliarPercent}}%"></view>
          <view class="bar-segment unseen" style="width: {{totalStats.analysis.unseenPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <view class="legend-item mastered">
            <view class="legend-dot"></view>
            <text>å·²æŒæ¡ {{totalStats.analysis.mastered}}</text>
          </view>
          <view class="legend-item partial">
            <view class="legend-dot"></view>
            <text>ç•¥æ‡‚ {{totalStats.analysis.partial}}</text>
          </view>
          <view class="legend-item unfamiliar">
            <view class="legend-dot"></view>
            <text>æœªæŒæ¡ {{totalStats.analysis.unfamiliar}}</text>
          </view>
          <view class="legend-item unseen">
            <view class="legend-dot"></view>
            <text>æœªçœ‹ {{totalStats.analysis.unseen}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å­¦ä¹ å»ºè®® -->
    <view class="suggestion-card">
      <view class="suggestion-title">ğŸ’¡ å­¦ä¹ å»ºè®®</view>
      <view class="suggestion-content">
        <view wx:if="{{totalStats.sentence.unfamiliar > 0}}" class="suggestion-item">
          <text class="suggestion-icon">ğŸ“</text>
          <text class="suggestion-text">è¿˜æœ‰ {{totalStats.sentence.unfamiliar}} ä¸ªå¥å­éœ€è¦é‡ç‚¹å­¦ä¹ </text>
        </view>
        <view wx:if="{{totalStats.word.unfamiliar > 0}}" class="suggestion-item">
          <text class="suggestion-icon">ğŸ“š</text>
          <text class="suggestion-text">è¿˜æœ‰ {{totalStats.word.unfamiliar}} ä¸ªè¯æ±‡éœ€è¦åŠ å¼ºè®°å¿†</text>
        </view>
        <view wx:if="{{totalStats.analysis.unfamiliar > 0}}" class="suggestion-item">
          <text class="suggestion-icon">ğŸ”</text>
          <text class="suggestion-text">è¿˜æœ‰ {{totalStats.analysis.unfamiliar}} ä¸ªè¯­æ³•ç‚¹éœ€è¦æ·±å…¥ç†è§£</text>
        </view>
        <view wx:if="{{totalStats.sentence.partial + totalStats.word.partial + totalStats.analysis.partial > 0}}" class="suggestion-item">
          <text class="suggestion-icon">ğŸ“–</text>
          <text class="suggestion-text">å»ºè®®å¤šå¤ä¹ "ç•¥æ‡‚"çš„å†…å®¹ï¼Œå·©å›ºè®°å¿†</text>
        </view>
        <view wx:if="{{totalStats.sentence.mastered === totalStats.sentence.total && totalStats.word.mastered === totalStats.word.total && totalStats.analysis.mastered === totalStats.analysis.total}}" class="suggestion-item success">
          <text class="suggestion-icon">ğŸ‰</text>
          <text class="suggestion-text">æ­å–œï¼æ‚¨å·²ç»æŒæ¡äº†æ‰€æœ‰å†…å®¹</text>
        </view>
      </view>
    </view>

    <!-- è¿›åº¦ç¯å½¢å›¾ -->
    <view class="progress-circle-card">
      <view class="progress-title">ğŸ¯ æ€»ä½“è¿›åº¦</view>
      <view class="progress-circle">
        <view class="circle-bg"></view>
        <view class="circle-progress" style="stroke-dasharray: {{(totalStats.sentence.mastered + totalStats.word.mastered + totalStats.analysis.mastered) / (totalStats.sentence.total + totalStats.word.total + totalStats.analysis.total) * 314}}, 314"></view>
        <view class="circle-text">
          <text class="progress-percent">{{Math.round((totalStats.sentence.mastered + totalStats.word.mastered + totalStats.analysis.mastered) / (totalStats.sentence.total + totalStats.word.total + totalStats.analysis.total) * 100) || 0}}%</text>
          <text class="progress-label">å·²æŒæ¡</text>
        </view>
      </view>
    </view>
    </view>
  </view>
</view>