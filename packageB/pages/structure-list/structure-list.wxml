<!-- pages/structure-list/structure-list.wxml -->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="header">
    <view class="title-section">
      <text class="page-title">{{pageTitle}}</text>
      <text class="structure-count">å…± {{totalCount}} ä¸ªå¥å­ç»“æ„</text>
      <text wx:if="{{structureList.length < totalCount}}" class="load-hint">
        å½“å‰æ˜¾ç¤º {{structureList.length}} ä¸ªï¼Œå‘ä¸‹æ»‘åŠ¨åŠ è½½æ›´å¤š
      </text>
      <view class="header-actions">
        <button wx:if="{{structureList.length < totalCount && hasMore}}" class="load-all-btn" bindtap="loadAllStructures">
          ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨
        </button>
        <button wx:if="{{type === 'mastered'}}" class="batch-reset-btn" bindtap="batchResetMastery">
          ğŸ”„ æ‰¹é‡é‡ç½®
        </button>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-bar">
    <view class="filter-item" bindtap="showCategoryFilter">
      <text class="filter-text">{{selectedCategoryName}}</text>
      <text class="filter-arrow">â–¼</text>
    </view>
    <view class="filter-item" bindtap="showDifficultyFilter">
      <text class="filter-text">{{selectedDifficultyName}}</text>
      <text class="filter-arrow">â–¼</text>
    </view>
  </view>

  <!-- å¥å­ç»“æ„åˆ—è¡¨ -->
  <scroll-view class="structure-list" scroll-y enable-back-to-top>
    <view wx:for="{{structureList}}" wx:key="_id" class="structure-item">
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <view class="item-header">
        <view class="item-main">
          <text class="structure-text">{{item.structure}}</text>
          <view class="item-meta">
            <text class="category-tag {{item.category}}">{{getCategoryName(item.category)}}</text>
            <text class="difficulty-tag {{item.difficulty}}">{{getDifficultyName(item.difficulty)}}</text>
          </view>
        </view>
        <view class="item-status">
          <text wx:if="{{item.totalOccurrences >= 3}}" class="status-badge mastered">å·²æŒæ¡</text>
          <text wx:else class="status-badge learning">å­¦ä¹ ä¸­</text>
        </view>
      </view>

      <!-- å­¦ä¹ ç»Ÿè®¡ -->
      <view class="item-stats">
        <text class="stat-item">å‡ºç° {{item.totalOccurrences}} æ¬¡</text>
        <text wx:if="{{item.examples && item.examples.length > 0}}" class="stat-item">ä¾‹å¥ {{item.examples.length}} ä¸ª</text>
        <text wx:if="{{item.tags && item.tags.length > 0}}" class="stat-item">{{item.tags[0]}}</text>
      </view>

      <!-- ç¬¬ä¸€ä¸ªä¾‹å¥é¢„è§ˆ -->
      <view wx:if="{{item.examples && item.examples.length > 0}}" class="item-example">
        <text class="example-jp">{{item.examples[0].jp}}</text>
        <text class="example-cn">{{item.examples[0].cn}}</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="item-actions">
        <button class="action-btn example-btn" bindtap="playAudio" data-text="{{item.examples[0].jp}}">
          ğŸ”Š å‘éŸ³
        </button>
        <button class="action-btn detail-btn" bindtap="showDetail" data-index="{{index}}">
          ğŸ“– è¯¦æƒ…
        </button>
        <button class="action-btn learn-btn" bindtap="addToLearningPlan" data-index="{{index}}">
          â• å­¦ä¹ 
        </button>
        <button wx:if="{{item.totalOccurrences >= 3}}" class="action-btn reset-btn" bindtap="resetMasteryStatus" data-index="{{index}}">
          ğŸ”„ é‡ç½®
        </button>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && structureList.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!loading && structureList.length === 0}}" class="empty">
      <text class="empty-icon">ğŸ“–</text>
      <text class="empty-text">æš‚æ— {{pageTitle}}</text>
      <text class="empty-hint">å»è§£ææ›´å¤šå†…å®¹æ¥ä¸°å¯Œå¥å­ç»“æ„åº“</text>
      <button class="empty-action" bindtap="goToParser">å¼€å§‹è§£æ</button>
    </view>
  </scroll-view>
</view>

<!-- å¥å­ç»“æ„è¯¦æƒ…å¼¹çª— -->
<view wx:if="{{showDetailModal}}" class="modal-mask" bindtap="hideDetail">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">å¥å­ç»“æ„è¯¦æƒ…</text>
      <text class="modal-close" bindtap="hideDetail">Ã—</text>
    </view>
    
    <view wx:if="{{selectedStructure}}" class="modal-body">
      <!-- ç»“æ„åŸºæœ¬ä¿¡æ¯ -->
      <view class="structure-info">
        <text class="structure-main">{{selectedStructure.structure}}</text>
        <view class="structure-tags">
          <text class="tag category-tag {{selectedStructure.category}}">{{getCategoryName(selectedStructure.category)}}</text>
          <text class="tag difficulty-tag {{selectedStructure.difficulty}}">{{getDifficultyName(selectedStructure.difficulty)}}</text>
        </view>
      </view>

      <!-- å­¦ä¹ ç»Ÿè®¡ -->
      <view class="structure-stats">
        <view class="stat-row">
          <text class="stat-label">å‡ºç°æ¬¡æ•°ï¼š</text>
          <text class="stat-value">{{selectedStructure.totalOccurrences}} æ¬¡</text>
        </view>
        <view class="stat-row">
          <text class="stat-label">å­¦ä¹ çŠ¶æ€ï¼š</text>
          <text class="stat-value {{selectedStructure.totalOccurrences >= 3 ? 'mastered' : 'learning'}}">
            {{selectedStructure.totalOccurrences >= 3 ? 'å·²æŒæ¡' : 'å­¦ä¹ ä¸­'}}
          </text>
        </view>
        <view class="stat-row">
          <text class="stat-label">éš¾åº¦çº§åˆ«ï¼š</text>
          <text class="stat-value">{{getDifficultyName(selectedStructure.difficulty)}}</text>
        </view>
      </view>

      <!-- ä¾‹å¥ -->
      <view wx:if="{{selectedStructure.examples && selectedStructure.examples.length > 0}}" class="examples-section">
        <text class="section-title">ä¾‹å¥</text>
        <view wx:for="{{selectedStructure.examples}}" wx:key="*this" class="example-item" wx:for-item="example">
          <text class="example-jp">{{example.jp}}</text>
          <text class="example-romaji" wx:if="{{example.romaji}}">{{example.romaji}}</text>
          <text class="example-cn">{{example.cn}}</text>
          <button class="play-example" bindtap="playAudio" data-text="{{example.jp}}">ğŸ”Š</button>
        </view>
      </view>

      <!-- æ¥æºæ ‡ç­¾ -->
      <view wx:if="{{selectedStructure.tags && selectedStructure.tags.length > 0}}" class="tags-section">
        <text class="section-title">æ ‡ç­¾</text>
        <view class="tag-list">
          <text wx:for="{{selectedStructure.tags}}" wx:key="*this" class="tag">{{item}}</text>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="modal-btn learn-btn" bindtap="addSelectedToLearningPlan">
        â• åŠ å…¥å­¦ä¹ è®¡åˆ’
      </button>
      <button wx:if="{{selectedStructure.totalOccurrences >= 3}}" class="modal-btn reset-btn" bindtap="resetSelectedMasteryStatus">
        ğŸ”„ é‡ç½®æŒæ¡çŠ¶æ€
      </button>
      <button class="modal-btn close-btn" bindtap="hideDetail">å…³é—­</button>
    </view>
  </view>
</view>

<!-- ç±»åˆ«ç­›é€‰å¼¹çª— -->
<view wx:if="{{showCategoryModal}}" class="modal-mask" bindtap="hideCategoryFilter">
  <view class="filter-modal" catchtap="stopPropagation">
    <view class="filter-header">
      <text class="filter-title">é€‰æ‹©ç±»åˆ«</text>
    </view>
    <view class="filter-options">
      <view wx:for="{{categoryOptions}}" wx:key="value" class="filter-option {{selectedCategory === item.value ? 'selected' : ''}}" 
            bindtap="selectCategory" data-value="{{item.value}}" data-name="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
        <text wx:if="{{selectedCategory === item.value}}" class="option-check">âœ“</text>
      </view>
    </view>
  </view>
</view>

<!-- éš¾åº¦ç­›é€‰å¼¹çª— -->
<view wx:if="{{showDifficultyModal}}" class="modal-mask" bindtap="hideDifficultyFilter">
  <view class="filter-modal" catchtap="stopPropagation">
    <view class="filter-header">
      <text class="filter-title">é€‰æ‹©éš¾åº¦</text>
    </view>
    <view class="filter-options">
      <view wx:for="{{difficultyOptions}}" wx:key="value" class="filter-option {{selectedDifficulty === item.value ? 'selected' : ''}}" 
            bindtap="selectDifficulty" data-value="{{item.value}}" data-name="{{item.name}}">
        <text class="option-text">{{item.name}}</text>
        <text wx:if="{{selectedDifficulty === item.value}}" class="option-check">âœ“</text>
      </view>
    </view>
  </view>
</view>