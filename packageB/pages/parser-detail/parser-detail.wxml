<!-- pages/parser-detail/parser-detail.wxml -->
<view class="container">
  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading-container">
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- è¯¦æƒ…å†…å®¹ -->
  <view wx:else class="detail-content">
    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <view class="header-info">
      <view class="input-method-tag">
        {{historyItem.inputMethod === 'image' ? 'å›¾ç‰‡è¯†åˆ«' : 'æ–‡æœ¬è¾“å…¥'}}
      </view>
      <view class="create-time">{{historyItem.displayTime || historyItem.createTime}}</view>
    </view>

    <!-- åŸå§‹è¾“å…¥ï¼ˆå¦‚æœæ˜¯æ–‡æœ¬ï¼‰ -->
    <view wx:if="{{historyItem.inputMethod === 'text' && historyItem.inputText}}" class="original-input">
      <view class="section-title">åŸå§‹è¾“å…¥</view>
      <view class="input-text">{{historyItem.inputText}}</view>
    </view>

    <!-- åŸå§‹å›¾ç‰‡ï¼ˆå¦‚æœæ˜¯å›¾ç‰‡ï¼‰ -->
    <view wx:if="{{historyItem.inputMethod === 'image' && historyItem.imageUrl}}" class="original-input">
      <view class="section-title">åŸå§‹å›¾ç‰‡</view>
      <image 
        src="{{historyItem.imageUrl}}" 
        mode="widthFix" 
        class="original-image"
        bindtap="previewImage"
        data-url="{{historyItem.imageUrl}}"
      ></image>
    </view>

    <!-- æŒæ¡åº¦æŠ¥å‘ŠæŒ‰é’® -->
    <view class="mastery-report-toggle" bindtap="toggleMasteryReport">
      <text class="report-btn">ğŸ“Š æŒæ¡åº¦æŠ¥å‘Š</text>
    </view>
    
    <!-- æŒæ¡åº¦æŠ¥å‘Šé¢æ¿ -->
    <view wx:if="{{showMasteryReport && masteryStats}}" class="mastery-report">
      <view class="report-title">å­¦ä¹ è¿›åº¦ç»Ÿè®¡</view>
      
      <!-- å¥å­æŒæ¡åº¦ -->
      <view class="stat-item">
        <text class="stat-label">å¥å­ ({{masteryStats.sentence.total}}ä¸ª)</text>
        <view class="stat-bar">
          <view class="bar-segment unseen" style="width: {{masteryStats.sentence.unseenPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{masteryStats.sentence.unfamiliarPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{masteryStats.sentence.partialPercent}}%"></view>
          <view class="bar-segment mastered" style="width: {{masteryStats.sentence.masteredPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <text class="legend-item unseen">æœªçœ‹ {{masteryStats.sentence.unseen}}</text>
          <text class="legend-item unfamiliar">æœªæŒæ¡ {{masteryStats.sentence.unfamiliar}}</text>
          <text class="legend-item partial">ç•¥æ‡‚ {{masteryStats.sentence.partial}}</text>
          <text class="legend-item mastered">æŒæ¡ {{masteryStats.sentence.mastered}}</text>
        </view>
      </view>
      
      <!-- è¯æ±‡æŒæ¡åº¦ -->
      <view class="stat-item">
        <text class="stat-label">è¯æ±‡ ({{masteryStats.word.total}}ä¸ª)</text>
        <view class="stat-bar">
          <view class="bar-segment unseen" style="width: {{masteryStats.word.unseenPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{masteryStats.word.unfamiliarPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{masteryStats.word.partialPercent}}%"></view>
          <view class="bar-segment mastered" style="width: {{masteryStats.word.masteredPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <text class="legend-item unseen">æœªçœ‹ {{masteryStats.word.unseen}}</text>
          <text class="legend-item unfamiliar">æœªæŒæ¡ {{masteryStats.word.unfamiliar}}</text>
          <text class="legend-item partial">ç•¥æ‡‚ {{masteryStats.word.partial}}</text>
          <text class="legend-item mastered">æŒæ¡ {{masteryStats.word.mastered}}</text>
        </view>
      </view>
      
      <!-- è¯­æ³•æŒæ¡åº¦ -->
      <view class="stat-item">
        <text class="stat-label">è¯­æ³• ({{masteryStats.grammar.total}}ä¸ª)</text>
        <view class="stat-bar">
          <view class="bar-segment unseen" style="width: {{masteryStats.grammar.unseenPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{masteryStats.grammar.unfamiliarPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{masteryStats.grammar.partialPercent}}%"></view>
          <view class="bar-segment mastered" style="width: {{masteryStats.grammar.masteredPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <text class="legend-item unseen">æœªçœ‹ {{masteryStats.grammar.unseen}}</text>
          <text class="legend-item unfamiliar">æœªæŒæ¡ {{masteryStats.grammar.unfamiliar}}</text>
          <text class="legend-item partial">ç•¥æ‡‚ {{masteryStats.grammar.partial}}</text>
          <text class="legend-item mastered">æŒæ¡ {{masteryStats.grammar.mastered}}</text>
        </view>
      </view>
    </view>

    <!-- è§£æç»“æœ -->
    <view class="analysis-results">
      <view class="section-header">
        <text class="section-title">è§£æç»“æœ ({{sentences.length}}ä¸ªå¥å­)</text>
        <text class="copy-all-btn" bindtap="copyAllContent">å¤åˆ¶å…¨éƒ¨</text>
      </view>

      <!-- å¥å­åˆ—è¡¨ -->
      <view wx:for="{{sentences}}" wx:for-item="sentence" wx:for-index="sIndex" wx:key="index" 
            class="sentence-item mastery-level-{{masteryLevels['s' + sIndex + '_sentence'] || 0}}">
        <view class="sentence-header">
          <text class="sentence-number">å¥å­ {{sIndex + 1}}</text>
          <view class="mastery-buttons">
            <text class="mastery-btn" bindtap="setMasteryLevel" 
                  data-type="sentence" data-id="s{{sIndex}}">
              {{masteryLevels['s' + sIndex + '_sentence'] == 3 ? 'âœ… æŒæ¡' : 
                masteryLevels['s' + sIndex + '_sentence'] == 2 ? 'ğŸ“– ç•¥æ‡‚' : 
                masteryLevels['s' + sIndex + '_sentence'] == 1 ? 'âŒ æœªæŒæ¡' : 'â­• æœªçœ‹'}}
            </text>
          </view>
        </view>

        <!-- åŸæ–‡ -->
        <view class="result-row">
          <text class="label">åŸæ–‡ï¼š</text>
          <text class="value japanese-text">{{sentence.originalText}}</text>
          <text class="copy-btn" bindtap="copyContent" data-text="{{sentence.originalText}}">å¤åˆ¶</text>
        </view>

        <!-- ç½—é©¬éŸ³ -->
        <view class="result-row" wx:if="{{sentence.romaji}}">
          <text class="label">ç½—é©¬éŸ³ï¼š</text>
          <text class="value romaji-text">{{sentence.romaji}}</text>
        </view>

        <!-- ç¿»è¯‘ -->
        <view class="result-row">
          <text class="label">ç¿»è¯‘ï¼š</text>
          <text class="value">{{sentence.translation}}</text>
        </view>

        <!-- å¥å‹ç»“æ„ -->
        <view class="result-row" wx:if="{{sentence.structure}}">
          <text class="label">å¥å‹ï¼š</text>
          <text class="value">{{sentence.structure}}</text>
        </view>

        <!-- è¯¦ç»†åˆ†æ -->
        <view wx:if="{{sentence.analysis}}" class="analysis-section">
          <text class="sub-label">è¯¦ç»†åˆ†æï¼š</text>
          <text class="analysis-text">{{sentence.analysis}}</text>
        </view>

        <!-- è¯­æ³•è¦ç‚¹ -->
        <view wx:if="{{sentence.grammar}}" class="grammar-section">
          <text class="sub-label">è¯­æ³•è¦ç‚¹ï¼š</text>
          <view class="grammar-list">
            <view wx:for="{{sentence.grammarPoints || [sentence.grammar]}}" wx:for-item="grammarPoint" wx:for-index="gIndex" wx:key="index"
                  class="grammar-item mastery-level-{{masteryLevels['s' + sIndex + '_grammar_' + gIndex] || 0}}">
              <text class="grammar-text">{{grammarPoint}}</text>
              <text class="mastery-btn mini" bindtap="setMasteryLevel" 
                    data-type="grammar_{{gIndex}}" data-id="s{{sIndex}}">
                {{masteryLevels['s' + sIndex + '_grammar_' + gIndex] == 3 ? 'âœ…' : 
                  masteryLevels['s' + sIndex + '_grammar_' + gIndex] == 2 ? 'ğŸ“–' : 
                  masteryLevels['s' + sIndex + '_grammar_' + gIndex] == 1 ? 'âŒ' : 'â­•'}}
              </text>
            </view>
          </view>
        </view>

        <!-- è¯æ±‡åˆ—è¡¨ -->
        <view wx:if="{{sentence.vocabulary && sentence.vocabulary.length > 0}}" class="vocabulary-section">
          <text class="sub-label">è¯æ±‡ï¼š</text>
          <view class="vocabulary-list">
            <view wx:for="{{sentence.vocabulary}}" wx:for-item="word" wx:for-index="wIndex" wx:key="japanese" 
                  class="vocabulary-item mastery-level-{{masteryLevels['s' + sIndex + '_word_' + wIndex] || 0}}">
              <text class="word-japanese">{{word.japanese}}</text>
              <text class="word-romaji">{{word.romaji}}</text>
              <text class="word-chinese">{{word.chinese}}</text>
              <text class="mastery-btn mini" bindtap="setMasteryLevel" 
                    data-type="word_{{wIndex}}" data-id="s{{sIndex}}">
                {{masteryLevels['s' + sIndex + '_word_' + wIndex] == 3 ? 'âœ…' : 
                  masteryLevels['s' + sIndex + '_word_' + wIndex] == 2 ? 'ğŸ“–' : 
                  masteryLevels['s' + sIndex + '_word_' + wIndex] == 1 ? 'âŒ' : 'â­•'}}
              </text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-bar">
      <button class="btn-back" bindtap="onBack">è¿”å›åˆ—è¡¨</button>
    </view>
  </view>
</view>