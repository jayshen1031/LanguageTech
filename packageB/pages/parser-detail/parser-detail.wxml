<!-- pages/parser-detail/parser-detail.wxml -->
<view class="container">
  <!-- 加载中 -->
  <view wx:if="{{loading}}" class="loading-container">
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 详情内容 -->
  <view wx:else class="detail-content">
    <!-- 头部信息 -->
    <view class="header-info">
      <view class="input-method-tag">
        {{historyItem.inputMethod === 'image' ? '图片识别' : '文本输入'}}
      </view>
      <view class="create-time">{{historyItem.displayTime || historyItem.createTime}}</view>
    </view>

    <!-- 原始输入（如果是文本） -->
    <view wx:if="{{historyItem.inputMethod === 'text' && historyItem.inputText}}" class="original-input">
      <view class="section-title">原始输入</view>
      <view class="input-text">{{historyItem.inputText}}</view>
    </view>

    <!-- 原始图片（如果是图片） -->
    <view wx:if="{{historyItem.inputMethod === 'image' && historyItem.imageUrl}}" class="original-input">
      <view class="section-title">原始图片</view>
      <image 
        src="{{historyItem.imageUrl}}" 
        mode="widthFix" 
        class="original-image"
        bindtap="previewImage"
        data-url="{{historyItem.imageUrl}}"
      ></image>
    </view>

    <!-- 掌握度报告按钮 -->
    <view class="mastery-report-toggle" bindtap="toggleMasteryReport">
      <text class="report-btn">📊 掌握度报告</text>
    </view>
    
    <!-- 掌握度报告面板 -->
    <view wx:if="{{showMasteryReport && masteryStats}}" class="mastery-report">
      <view class="report-title">学习进度统计</view>
      
      <!-- 句子掌握度 -->
      <view class="stat-item">
        <text class="stat-label">句子 ({{masteryStats.sentence.total}}个)</text>
        <view class="stat-bar">
          <view class="bar-segment unseen" style="width: {{masteryStats.sentence.unseenPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{masteryStats.sentence.unfamiliarPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{masteryStats.sentence.partialPercent}}%"></view>
          <view class="bar-segment mastered" style="width: {{masteryStats.sentence.masteredPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <text class="legend-item unseen">未看 {{masteryStats.sentence.unseen}}</text>
          <text class="legend-item unfamiliar">未掌握 {{masteryStats.sentence.unfamiliar}}</text>
          <text class="legend-item partial">略懂 {{masteryStats.sentence.partial}}</text>
          <text class="legend-item mastered">掌握 {{masteryStats.sentence.mastered}}</text>
        </view>
      </view>
      
      <!-- 词汇掌握度 -->
      <view class="stat-item">
        <text class="stat-label">词汇 ({{masteryStats.word.total}}个)</text>
        <view class="stat-bar">
          <view class="bar-segment unseen" style="width: {{masteryStats.word.unseenPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{masteryStats.word.unfamiliarPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{masteryStats.word.partialPercent}}%"></view>
          <view class="bar-segment mastered" style="width: {{masteryStats.word.masteredPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <text class="legend-item unseen">未看 {{masteryStats.word.unseen}}</text>
          <text class="legend-item unfamiliar">未掌握 {{masteryStats.word.unfamiliar}}</text>
          <text class="legend-item partial">略懂 {{masteryStats.word.partial}}</text>
          <text class="legend-item mastered">掌握 {{masteryStats.word.mastered}}</text>
        </view>
      </view>
      
      <!-- 语法掌握度 -->
      <view class="stat-item">
        <text class="stat-label">语法 ({{masteryStats.grammar.total}}个)</text>
        <view class="stat-bar">
          <view class="bar-segment unseen" style="width: {{masteryStats.grammar.unseenPercent}}%"></view>
          <view class="bar-segment unfamiliar" style="width: {{masteryStats.grammar.unfamiliarPercent}}%"></view>
          <view class="bar-segment partial" style="width: {{masteryStats.grammar.partialPercent}}%"></view>
          <view class="bar-segment mastered" style="width: {{masteryStats.grammar.masteredPercent}}%"></view>
        </view>
        <view class="stat-legend">
          <text class="legend-item unseen">未看 {{masteryStats.grammar.unseen}}</text>
          <text class="legend-item unfamiliar">未掌握 {{masteryStats.grammar.unfamiliar}}</text>
          <text class="legend-item partial">略懂 {{masteryStats.grammar.partial}}</text>
          <text class="legend-item mastered">掌握 {{masteryStats.grammar.mastered}}</text>
        </view>
      </view>
    </view>

    <!-- 解析结果 -->
    <view class="analysis-results">
      <view class="section-header">
        <text class="section-title">解析结果 ({{sentences.length}}个句子)</text>
        <text class="copy-all-btn" bindtap="copyAllContent">复制全部</text>
      </view>

      <!-- 句子列表 -->
      <view wx:for="{{sentences}}" wx:for-item="sentence" wx:for-index="sIndex" wx:key="index" 
            class="sentence-item mastery-level-{{masteryLevels['s' + sIndex + '_sentence'] || 0}}">
        <view class="sentence-header">
          <text class="sentence-number">句子 {{sIndex + 1}}</text>
          <view class="mastery-buttons">
            <text class="mastery-btn" bindtap="setMasteryLevel" 
                  data-type="sentence" data-id="s{{sIndex}}">
              {{masteryLevels['s' + sIndex + '_sentence'] == 3 ? '✅ 掌握' : 
                masteryLevels['s' + sIndex + '_sentence'] == 2 ? '📖 略懂' : 
                masteryLevels['s' + sIndex + '_sentence'] == 1 ? '❌ 未掌握' : '⭕ 未看'}}
            </text>
          </view>
        </view>

        <!-- 原文 -->
        <view class="result-row">
          <text class="label">原文：</text>
          <text class="value japanese-text">{{sentence.originalText}}</text>
          <text class="copy-btn" bindtap="copyContent" data-text="{{sentence.originalText}}">复制</text>
        </view>

        <!-- 罗马音 -->
        <view class="result-row" wx:if="{{sentence.romaji}}">
          <text class="label">罗马音：</text>
          <text class="value romaji-text">{{sentence.romaji}}</text>
        </view>

        <!-- 翻译 -->
        <view class="result-row">
          <text class="label">翻译：</text>
          <text class="value">{{sentence.translation}}</text>
        </view>

        <!-- 句型结构 -->
        <view class="result-row" wx:if="{{sentence.structure}}">
          <text class="label">句型：</text>
          <text class="value">{{sentence.structure}}</text>
        </view>

        <!-- 详细分析 -->
        <view wx:if="{{sentence.analysis}}" class="analysis-section">
          <text class="sub-label">详细分析：</text>
          <text class="analysis-text">{{sentence.analysis}}</text>
        </view>

        <!-- 语法要点 -->
        <view wx:if="{{sentence.grammar}}" class="grammar-section">
          <text class="sub-label">语法要点：</text>
          <view class="grammar-list">
            <view wx:for="{{sentence.grammarPoints || [sentence.grammar]}}" wx:for-item="grammarPoint" wx:for-index="gIndex" wx:key="index"
                  class="grammar-item mastery-level-{{masteryLevels['s' + sIndex + '_grammar_' + gIndex] || 0}}">
              <text class="grammar-text">{{grammarPoint}}</text>
              <text class="mastery-btn mini" bindtap="setMasteryLevel" 
                    data-type="grammar_{{gIndex}}" data-id="s{{sIndex}}">
                {{masteryLevels['s' + sIndex + '_grammar_' + gIndex] == 3 ? '✅' : 
                  masteryLevels['s' + sIndex + '_grammar_' + gIndex] == 2 ? '📖' : 
                  masteryLevels['s' + sIndex + '_grammar_' + gIndex] == 1 ? '❌' : '⭕'}}
              </text>
            </view>
          </view>
        </view>

        <!-- 词汇列表 -->
        <view wx:if="{{sentence.vocabulary && sentence.vocabulary.length > 0}}" class="vocabulary-section">
          <text class="sub-label">词汇：</text>
          <view class="vocabulary-list">
            <view wx:for="{{sentence.vocabulary}}" wx:for-item="word" wx:for-index="wIndex" wx:key="japanese" 
                  class="vocabulary-item mastery-level-{{masteryLevels['s' + sIndex + '_word_' + wIndex] || 0}}">
              <text class="word-japanese">{{word.japanese}}</text>
              <text class="word-romaji">{{word.romaji}}</text>
              <text class="word-chinese">{{word.chinese}}</text>
              <text class="mastery-btn mini" bindtap="setMasteryLevel" 
                    data-type="word_{{wIndex}}" data-id="s{{sIndex}}">
                {{masteryLevels['s' + sIndex + '_word_' + wIndex] == 3 ? '✅' : 
                  masteryLevels['s' + sIndex + '_word_' + wIndex] == 2 ? '📖' : 
                  masteryLevels['s' + sIndex + '_word_' + wIndex] == 1 ? '❌' : '⭕'}}
              </text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 底部操作栏 -->
    <view class="bottom-bar">
      <button class="btn-back" bindtap="onBack">返回列表</button>
    </view>
  </view>
</view>