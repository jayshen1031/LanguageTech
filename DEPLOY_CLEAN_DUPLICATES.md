# 部署清理重复句子结构云函数

## 📋 部署步骤

### 1. 使用微信开发者工具部署

1. **打开微信开发者工具**
   - 确保已经打开了语伴君项目
   - 确保网络连接正常

2. **找到云函数**
   - 在项目目录中，展开 `cloudfunctions` 文件夹
   - 找到 `clean-duplicate-structures` 文件夹

3. **上传并部署**
   - 右键点击 `clean-duplicate-structures` 文件夹
   - 选择 "上传并部署：云端安装依赖（不上传node_modules）"
   - 等待部署完成

### 2. 验证部署成功

部署完成后，可以通过以下方式验证：

```javascript
// 在微信开发者工具的调试器中运行
wx.cloud.callFunction({
  name: 'clean-duplicate-structures'
}).then(result => {
  console.log('云函数部署成功:', result)
}).catch(error => {
  console.error('云函数调用失败:', error)
})
```

## 🚀 自动执行机制

### 工作原理

1. **首页加载时自动检查**
   - 检查本地存储标志 `hasCleanedDuplicates`
   - 如果从未执行过，延迟3秒后自动执行清理

2. **执行一次后自动禁用**
   - 清理完成后设置标志 `hasCleanedDuplicates = true`
   - 避免重复执行，提升性能

3. **清理逻辑**
   - 获取所有句子结构记录
   - 按 `structure` 字段分组查找重复
   - 智能合并：保留最丰富的记录，合并所有例句
   - 删除重复记录，更新统计

### 预期效果

- ✅ 自动清理718个重复记录中的重复项
- ✅ 保留所有有用的例句和来源信息
- ✅ 更新首页句子结构统计显示
- ✅ 后续新增记录自动去重，不再产生重复

## 📊 清理结果示例

```
🎉 清理完成! 合并了45个结构，删除了123条重复记录
- 原始记录: 718条
- 最终记录: 595条  
- 清理效率: 17%
```

## 🔧 手动测试

如需手动测试，可以：

1. **临时清除标志**
   ```javascript
   wx.removeStorageSync('hasCleanedDuplicates')
   ```

2. **重新进入首页**
   - 系统会重新执行自动清理

3. **查看控制台输出**
   - 观察清理过程和结果

## 📝 注意事项

1. **只执行一次**: 首次运行后会设置标志，避免重复执行
2. **延迟执行**: 页面加载后延迟3秒执行，确保页面稳定
3. **静默处理**: 清理过程在后台进行，不会阻断用户操作
4. **错误处理**: 即使云函数调用失败也不会影响正常使用

## ✅ 完成标志

当你看到：
- 首页句子结构数量不再是718
- 控制台显示清理完成消息
- 本地存储中有 `hasCleanedDuplicates = true`

说明自动清理系统已经成功运行！