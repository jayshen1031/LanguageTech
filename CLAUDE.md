# 语伴君 项目记忆

## 项目概述
语伴君是一款基于微信小程序的日语/英语学习应用，结合 GPT 智能语法分析、对话生成与记忆曲线的语言学习工具。

## 技术栈
- **前端**: 微信小程序原生框架 + Vant Weapp UI
- **后端**: 微信云开发（云函数 + 云数据库）
- **云环境ID**: cloud1-2g49srond2b01891
- **AI服务**: 
  - Azure OpenAI GPT-4o（主要，支持图片识别和长文本）
  - DeepSeek AI（备选，支持文本分析）
  - 腾讯混元AI（备选）
- **数据库**: 微信云开发数据库（MongoDB风格）
- **音频处理**: MCP服务 + 云函数TTS + 腾讯云语音识别

## 项目结构
```
LanguageTech/
├── pages/              # 主包页面
│   ├── index/         # 首页
│   ├── learn/         # 学习页
│   ├── review/        # 复习页
│   ├── parser-history/ # 解析历史记录
│   ├── profile/       # 个人中心
│   └── mastery-stats/ # 学习统计页面
├── packageA/          # 分包A
│   └── pages/
│       ├── voice-dialogue/ # 语音对话
│       ├── kana-merged/   # 假名学习
│       ├── grammar-study/ # 语法学习
│       └── grammar-library/ # 语法库
├── packageB/          # 分包B
│   └── pages/
│       ├── japanese-parser/ # 日语解析（支持歌词分批处理）
│       ├── parser-detail/  # 解析详情
│       ├── parser-review/  # 解析内容复习
│       ├── history-vocabulary/ # 历史词汇
│       ├── vocabulary-search/ # 词汇搜索
│       └── learning-plan/  # 学习计划
├── packageAdmin/      # 管理分包
│   └── pages/
│       ├── admin/import-n2 # 词汇导入
│       └── todo-manage/    # 项目待办管理
├── components/         # 自定义组件
│   ├── word-card/     # 单词卡片
│   ├── progress-bar/  # 进度条
│   ├── dialogue-box/  # 对话框
│   └── voice-recorder/ # 录音组件
├── cloudfunctions/    # 云函数目录
│   ├── azure-gpt4o/   # Azure GPT-4o主云函数
│   ├── azure-gpt4o-batch/ # GPT-4o批处理云函数
│   ├── azure-gpt4o-fast/ # GPT-4o快速云函数
│   ├── deepseek-ai/   # DeepSeek AI云函数
│   ├── tts-service/   # TTS语音合成服务
│   ├── asr-service/   # ASR语音识别
│   ├── todo-manage/   # 待办事项管理
│   └── init-vocabulary/ # 词汇初始化
├── utils/             # 工具函数
│   ├── request.js     # 网络请求封装
│   ├── auth.js        # 授权相关
│   ├── ai.js          # AI接口封装
│   ├── audioMCP.js    # MCP音频客户端
│   ├── voiceService.js # 语音服务封装
│   ├── memory.js      # 记忆曲线算法
│   ├── audioData.js   # 音频数据
│   ├── deepseekAI.js  # DeepSeek AI接口
│   ├── grammarData.js # 语法数据
│   ├── kanaData.js    # 假名数据
│   └── tcbAI.js       # 腾讯云AI接口
├── audio-mcp-server/  # MCP音频服务器（开发用）
├── data/              # 数据文件
├── images/            # 图片资源
├── app.js             # 小程序入口
├── app.json           # 小程序配置
├── app.wxss           # 全局样式
└── project.config.json # 项目配置
```

## 音频缓存方案
 ⏺ ✅ 音频缓存方案完成！

  实现的简单有效方案：
  1. URL缓存 - 第一次播放成功后缓存TTS URL
  2. 智能重用 - 下次播放同一单词直接使用缓存的URL
  3. 系统优化 - 利用小程序自身的网络和音频缓存机制
  4. 降级保障 - TTS失败时自动降级到云函数方案

## 首页词汇统计点击功能
 ⏺ ✅ 首页词汇统计可点击查看列表功能完成！

  实现功能：
  1. **首页统计卡片点击跳转** - 为总词汇量(271)、已掌握(31)、未掌握(240)添加点击事件
  2. **新建词汇列表页面** - 创建 `packageB/pages/vocabulary-list/vocabulary-list`
  3. **简洁词汇展示** - 列表显示：单词、罗马音、中文解释
  4. **分类显示支持** - 根据参数显示全部/已掌握/未掌握词汇
  5. **词汇详情弹窗** - 点击详情可查看完整信息和例句
  6. **发音播放功能** - 集成音频播放，支持单词发音
  7. **点击视觉反馈** - 统计卡片添加点击效果和动画

  页面特性：
  - 🎯 **智能分类**：根据出现次数判断掌握程度（≥3次为已掌握）
  - 📱 **响应式设计**：美观的卡片式布局
  - 🔊 **音频集成**：支持单词和例句发音
  - 📊 **学习统计**：显示出现次数、例句数量等信息
  - 🎨 **用户体验**：下拉刷新、上拉加载更多、空状态处理

  文件更新：
  - ✅ `pages/index/index.wxml` - 添加点击事件
  - ✅ `pages/index/index.js` - 添加跳转方法
  - ✅ `pages/index/index.wxss` - 添加点击样式
  - ✅ `packageB/pages/vocabulary-list/*` - 新建完整页面
  - ✅ `app.json` - 添加页面路由配置

## 句子结构管理系统
 ⏺ ✅ 句子结构管理系统完成！

  实现功能：
  1. **句子结构数据整合** - 从解析历史中提取并去重句子结构、语法要点、句法分析
  2. **智能分类系统** - 自动分类为：句子结构、语法要点、句法分析三大类别
  3. **难度级别划分** - 根据内容长度自动分级：基础、中级、高级
  4. **首页统计展示** - 新增句子结构统计卡片，支持点击查看
  5. **专业列表页面** - 创建 `packageB/pages/structure-list/structure-list`
  6. **高级筛选功能** - 支持按类别、难度、掌握程度筛选
  7. **学习计划集成** - 支持将句子结构加入学习计划

  数据结构特点：
  - 🎯 **智能去重**：相同结构自动合并，统计出现次数
  - 📊 **掌握度判断**：出现3次以上认为已掌握
  - 🔍 **例句关联**：每个结构保留原始例句和来源
  - 🏷️ **标签系统**：自动标记来源和类型
  - 📈 **使用统计**：记录首次/最后出现时间

  页面功能：
  - ✅ **分类筛选**：句子结构/语法要点/句法分析
  - ✅ **难度筛选**：基础/中级/高级
  - ✅ **掌握度显示**：已掌握/学习中状态
  - ✅ **例句预览**：显示第一个例句作为预览
  - ✅ **详情弹窗**：完整信息展示，包括所有例句
  - ✅ **发音播放**：支持例句发音
  - ✅ **一键加载**：支持一次性加载全部结构
  - ✅ **学习计划**：快速加入学习计划功能

  技术架构：
  - 📦 **云函数支持**：`sentence-structure-integration` 云函数
  - 🗄️ **数据库表**：`sentence_structures_integrated` 集合
  - 🔄 **前端整合**：支持前端自动整合，无需云函数部署
  - 📱 **响应式设计**：美观的移动端界面
  - ⚡ **性能优化**：分页加载、缓存机制

  文件创建：
  - ✅ `cloudfunctions/sentence-structure-integration/*` - 句子结构整合云函数
  - ✅ `pages/index/index.js` - 添加句子结构统计和整合逻辑
  - ✅ `pages/index/index.wxml` - 添加句子结构统计卡片
  - ✅ `pages/index/index.wxss` - 添加句子结构卡片样式
  - ✅ `packageB/pages/structure-list/*` - 完整的句子结构列表页面
  - ✅ `packageB/pages/japanese-parser/japanese-parser.js` - 添加增量整合逻辑
  - ✅ `app.json` - 添加新页面路由

## 数据库结构和增量更新机制
 ⏺ ✅ 完整的数据持久化和增量更新系统！

  **数据库集合**: `sentence_structures_integrated`
  
  **字段结构**:
  ```javascript
  {
    structure: "主语は動詞します", // 句子结构文本
    examples: [  // 例句数组
      {
        jp: "私は日本語を勉強します",
        romaji: "watashi wa nihongo wo benkyou shimasu", 
        cn: "我学习日语",
        source: "解析记录",
        recordId: "解析记录ID",
        sentenceIndex: 0
      }
    ],
    sources: ["record_id_1"], // 来源记录ID数组
    totalOccurrences: 3, // 出现总次数
    firstSeen: Date, // 首次出现时间
    lastSeen: Date,  // 最后出现时间
    category: "sentence_structure", // 类别
    difficulty: "basic", // 难度级别
    tags: ["句子结构"] // 标签数组
  }
  ```

  **增量更新机制**:
  1. **新解析触发更新** - 每次解析完成自动调用增量整合
  2. **智能去重合并** - 相同结构自动合并，新例句追加到examples数组
  3. **实时统计更新** - 统计totalOccurrences，更新lastSeen时间
  4. **首页统计刷新** - 整合完成后自动刷新首页数据
  5. **用户提示反馈** - 显示"已整合X个句子结构"提示

  **工作流程**:
  ```
  用户解析新内容 → japanese-parser保存历史 → 
  自动调用integrateStructuresToLearning → 
  提取句子结构+语法点 → 检查数据库是否存在 → 
  新增或更新记录 → 刷新首页统计 → 用户看到更新
  ```

  **支持的数据提取**:
  - 📝 **句子结构** - 从sentence.structure字段提取
  - 📚 **语法要点** - 从sentence.grammar字段解析提取  
  - 🔍 **句法分析** - 从sentence.analysis字段解析提取
  - 🏷️ **自动分类** - 根据内容特征自动归类
  - ⭐ **难度评级** - 根据长度自动评定难度等级

## 重复数据合并功能
 ⏺ ✅ 句子结构去重合并工具完成！

  **问题解决**: 
  - 🔍 **重复检测** - 718个句子结构中发现重复项
  - 🔄 **智能合并** - 相同结构自动合并，保留所有例句
  - 📊 **数据优化** - 减少冗余，提高数据质量

  **核心功能**:
  1. **重复检查** - 统计重复情况，显示详细报告
  2. **智能合并** - 保留最优记录，合并所有例句和来源
  3. **数据清理** - 删除重复记录，优化数据库结构
  4. **实时更新** - 合并完成后自动刷新首页统计

  **合并策略**:
  - 🎯 **保留策略** - 选择examples最多或创建时间最早的记录
  - 📚 **例句合并** - 合并所有不重复的例句
  - 🔗 **来源追踪** - 合并所有来源记录ID
  - ⏰ **时间优化** - 保留最早和最晚的时间戳
  - 📊 **统计更新** - 重新计算totalOccurrences

  **用户界面**:
  - 🔍 **检查重复按钮** - 首页句子结构卡片右上角
  - 🔄 **合并重复按钮** - 一键执行合并操作
  - 📋 **详细报告** - 显示合并前后的统计对比
  - ✅ **操作确认** - 重要操作需要用户确认

  **文件创建**:
  - ✅ `utils/mergeStructures.js` - 重复检查和合并工具
  - ✅ `pages/index/index.wxml` - 添加管理按钮
  - ✅ `pages/index/index.js` - 添加合并功能方法
  - ✅ `pages/index/index.wxss` - 添加按钮样式

## 解析历史标签编辑功能
 ⏺ ✅ 解析历史记录标签编辑功能完成！

  **实现功能**:
  1. **标签编辑** - 为已有标签的记录提供编辑和删除功能
  2. **标签添加** - 为没有标签的记录提供快速添加功能
  3. **智能选择** - 优先显示已存在的标签选项，支持快速复用
  4. **自定义输入** - 支持自定义新标签，灵活扩展分类体系
  5. **实时更新** - 云数据库和本地存储同步更新
  6. **分类管理** - 自动维护可用分类列表，支持分类筛选

  **用户体验特性**:
  - 🏷️ **已有标签** - 显示标签+编辑按钮（✏️），点击可修改或删除
  - ➕ **无标签记录** - 显示"+ 添加标签"按钮，点击即可添加
  - 📋 **智能选择** - 优先显示现有标签选项，最后提供"+ 自定义新标签"
  - ✅ **操作确认** - 删除标签需要确认，防止误操作
  - 🔄 **实时同步** - 修改后立即更新界面，无需刷新

  **技术实现**:
  - 🔧 **权限控制** - 只有登录用户可以编辑标签
  - 🗄️ **数据同步** - 云数据库和本地存储双重更新
  - 📱 **响应式设计** - 编辑按钮和添加按钮的美观布局
  - 🎨 **视觉反馈** - 按钮点击效果和动画过渡
  - 📊 **分类统计** - 自动更新可用分类列表

  **核心方法**:
  - `onEditCategory()` - 编辑现有标签，提供修改/删除选项
  - `onAddCategory()` - 为无标签记录添加新标签
  - `showCategoryInput()` - 智能显示标签选择界面
  - `showCustomCategoryInput()` - 自定义标签输入界面
  - `updateCategory()` - 统一的标签更新方法
  - `updateAvailableCategories()` - 维护可用分类列表

  **文件更新**:
  - ✅ `pages/parser-history/parser-history.wxml` - 添加标签编辑UI组件
  - ✅ `pages/parser-history/parser-history.wxss` - 添加编辑按钮样式
  - ✅ `pages/parser-history/parser-history.js` - 实现完整的标签编辑逻辑

## 学习计划解析历史标签筛选功能
 ⏺ ✅ 学习计划解析历史标签筛选功能完成！

  **实现功能**:
  1. **双内容源支持** - JLPT词汇库 + 解析历史内容
  2. **标签智能筛选** - 基于解析历史中的分类标签进行筛选
  3. **动态标签加载** - 自动从云数据库和本地存储加载可用标签
  4. **可视化切换** - Tab切换界面，支持不同内容源选择
  5. **标签统计显示** - 显示每个标签下的内容数量

  **用户体验特性**:
  - 📚 **JLPT词汇** - 传统的N2词汇学习，按难度分类
  - 🏷️ **解析历史** - 基于用户解析内容，按标签分类学习
  - 📊 **智能统计** - 显示每个标签的内容数量
  - 🎯 **个性化学习** - 根据用户解析的内容类型定制学习计划
  - 💭 **空状态提示** - 引导用户添加标签和解析内容

  **技术实现**:
  - 🔄 **数据源整合** - 云数据库 + 本地存储双重支持
  - 📱 **响应式设计** - 美观的Tab切换和标签选择界面
  - 🎨 **视觉反馈** - 选中状态和点击效果
  - 🔧 **权限控制** - 未登录用户也可查看本地内容

  **核心方法**:
  - `loadHistoryTags()` - 加载解析历史中的所有标签
  - `onContentSourceChange()` - 切换内容源（词汇库/解析历史）
  - `onHistoryTagSelect()` - 选择/取消选择历史标签

  **文件更新**:
  - ✅ `packageB/pages/learning-plan/learning-plan.wxml` - 添加标签筛选UI
  - ✅ `packageB/pages/learning-plan/learning-plan.wxss` - 添加标签筛选样式
  - ✅ `packageB/pages/learning-plan/learning-plan.js` - 实现标签筛选逻辑

## 例句罗马音显示修复与实时修复功能
 ⏺ ✅ 例句罗马音显示功能修复完成！

  **问题修复**:
  1. **词汇列表页面** - 例句详情弹窗缺少罗马音显示
  2. **云函数数据源** - 词汇整合时例句对象缺少romaji字段
  3. **数据传递链路** - 从解析到词汇库的完整数据传递

  **修复范围**:
  - 🔧 **前端显示** - 词汇列表页面例句增加罗马音显示
  - 🗄️ **云函数修复** - vocabulary-integration增量和重建逻辑
  - 🔗 **数据传递** - 确保sourceRomaji字段正确传递
  - 🎨 **样式优化** - 罗马音显示的字体和颜色优化

  **修复文件**:
  - ✅ `packageB/pages/vocabulary-list/vocabulary-list.wxml` - 添加罗马音显示
  - ✅ `packageB/pages/vocabulary-list/vocabulary-list.wxss` - 添加罗马音样式
  - ✅ `cloudfunctions/vocabulary-integration/index.js` - 修复例句数据结构

 ⏺ ✅ 实时罗马音修复功能完成！

  **终极解决方案**:
  基于用户反馈"我每次都要运行这个修复代码么"，实现了智能的实时修复功能，用户无需手动操作。

  **核心特性**:
  1. **自动触发** - 在数据加载时自动检测和修复缺失的罗马音
  2. **智能映射** - 从解析历史构建句子罗马音映射表，支持云数据库和本地存储双重数据源
  3. **实时补全** - 学习页面和词汇列表页面加载时自动补全缺失的例句罗马音
  4. **无缝体验** - 用户无感知的后台修复，只在有修复内容时显示简单提示
  5. **容错设计** - 修复失败不影响正常功能，降级使用原始数据

  **实现页面**:
  - ✅ **智能学习页面** (`pages/learn/learn.js`) - `autoFixRomajiInWords()` 函数
  - ✅ **词汇列表页面** (`packageB/pages/vocabulary-list/vocabulary-list.js`) - `autoFixRomajiInVocabulary()` 函数

  **技术架构**:
  - 📊 **数据映射** - `buildRomajiMapFromHistory()` 构建罗马音映射表
  - 🔄 **实时修复** - 在`loadTodayWords()`和`loadVocabularyList()`中集成修复逻辑
  - 🎯 **精准匹配** - 基于例句日文原文精确匹配罗马音数据
  - 📱 **用户体验** - 仅在有修复时显示"已修复X个例句"提示

  **工作流程**:
  ```
  页面加载 → 获取词汇数据 → 自动检测缺失罗马音 → 
  从解析历史构建映射 → 补全缺失的罗马音 → 
  显示修复结果 → 正常展示页面
  ```

  **优势**:
  - 🚀 **即时生效** - 无需云函数部署或数据库重建
  - 💾 **数据安全** - 不修改原始数据库，仅前端实时补全
  - 🔄 **智能缓存** - 映射表在同一会话中复用，提高性能
  - 🎯 **精准修复** - 只修复真正缺失的数据，不影响已有数据
  - 📈 **完美兼容** - 兼容云数据库和本地存储双重数据源

## 解析后自动更新统计数据修复
 ⏺ ✅ 解析后自动更新统计数据功能修复完成！

  **问题解决**:
  - 用户解析新内容后，首页词汇总量和句型总量不会自动更新
  - 需要手动刷新页面才能看到最新统计数据

  **解决方案**:
  1. **自动触发整合** - 解析保存成功后自动调用词汇和句子结构整合
  2. **页面数据刷新** - 自动刷新首页和历史页面的统计数据
  3. **实时反馈** - 用户立即看到解析成果的统计更新

  **核心改进**:
  - 🔄 **自动整合** - saveParseResult后自动调用整合函数
  - 📊 **实时更新** - 首页统计数据实时刷新
  - 🎯 **用户体验** - 无需手动操作，自动看到更新结果
  - ⚡ **即时反馈** - 解析完成后立即显示统计变化

  **修复文件**:
  - ✅ `packageB/pages/japanese-parser/japanese-parser.js` - 添加自动整合和刷新逻辑

## 学习设置页面标签筛选功能完善 (2025-10-08)
 ⏺ ✅ 学习设置页面标签筛选功能完成！

  **核心问题解决**:
  - 用户反馈：点击"今日学习计划"右边的设置按钮，没有看到标签选择功能
  - 原因：标签筛选只在学习页面的初始设置弹窗中，用户开启"自动学习"后就看不到了
  - 解决：在学习设置页面 (`pages/study-settings/study-settings`) 添加标签筛选功能

  **实现功能**:
  1. **学习设置页面UI** - 在词汇学习设置区域添加"学习来源筛选"
  2. **横向滚动标签** - 显示"全部来源" + 所有可用标签
  3. **标签数据加载** - 从云数据库和本地存储加载解析历史标签
  4. **标签选择交互** - 点击标签切换选中状态，支持取消选择
  5. **配置持久化** - 保存选中标签到 `studyPlanConfig.selectedTag`
  6. **智能学习集成** - 首页智能学习按钮自动读取标签并传递

  **用户体验特性**:
  - 📚 **统一入口** - 首页删除独立的词汇学习和语法结构学习，统一为智能学习
  - ⚙️ **便捷设置** - 点击"设置"按钮即可进入标签筛选页面
  - 🏷️ **智能标签** - 自动识别解析历史中的所有分类标签
  - 🎨 **美观交互** - 选中标签渐变背景+阴影效果
  - 💾 **自动应用** - 保存后下次智能学习自动使用选中标签

  **技术实现**:
  1. **study-settings 页面改造**:
     - 添加 `availableTags` 和 `selectedTag` 数据字段
     - `loadAvailableTags()` - 加载所有可用标签
     - `onSelectTag()` - 处理标签选择
     - `saveSettings()` - 保存标签到配置

  2. **首页智能学习跳转**:
     - `goToSmartPlan()` - 读取 `studyPlanConfig.selectedTag`
     - URL参数传递：`/pages/learn/learn?count=10&type=mixed&tag=NHK`

  3. **学习页面接收**:
     - `onLoad()` - 从URL参数 `options.tag` 读取标签
     - `loadTodayWords()` - 将标签传递给云函数筛选

  **数据流程**:
  ```
  解析历史添加标签 → study-settings加载标签列表 →
  用户选择标签并保存 → studyPlanConfig.selectedTag →
  首页智能学习读取标签 → URL参数传递 →
  学习页面接收标签 → 云函数按标签筛选词汇
  ```

  **文件更新**:
  - ✅ `pages/study-settings/study-settings.wxml` - 添加标签筛选UI
  - ✅ `pages/study-settings/study-settings.wxss` - 添加标签芯片样式
  - ✅ `pages/study-settings/study-settings.js` - 实现标签加载和保存逻辑
  - ✅ `pages/index/index.wxml` - 删除独立学习入口，保留智能学习
  - ✅ `pages/index/index.js` - 智能学习跳转时传递标签参数
  - ✅ `pages/learn/learn.js` - 从URL读取标签参数

  **Git提交**:
  - Commit: `4f8283b`
  - 标题: ✨ 完善学习设置页面标签筛选功能
  - 75个文件修改，9094行新增

  **核心价值**:
  - 🎯 **用户友好** - 设置入口清晰，操作简单直观
  - 🔄 **统一体验** - 从设置到学习的完整闭环
  - 📊 **个性化学习** - 支持按来源标签定制学习内容
  - 💪 **技术完善** - 数据流转清晰，配置持久化可靠