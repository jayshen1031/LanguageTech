# 云开发部署指南

## 云环境配置

**云环境ID**: `cloud1-2g49srond2b01891`

## 部署步骤

### 1. 在微信开发者工具中配置云开发

1. 打开微信开发者工具
2. 点击顶部菜单栏 "云开发"
3. 选择 "云开发控制台"
4. 确认环境ID为：`cloud1-2g49srond2b01891`

### 2. 部署云函数

#### 2.1 部署 tts-service 云函数

1. 在微信开发者工具中右键点击 `cloudfunctions/tts-service`
2. 选择 "上传并部署：云端安装依赖"
3. 等待部署完成

#### 2.2 部署 audio-tts 云函数（备用）

1. 右键点击 `cloudfunctions/audio-tts`
2. 选择 "上传并部署：云端安装依赖"

### 3. 配置数据库

#### 3.1 创建集合

在云开发控制台中创建以下集合：

1. **audio_cache** - 音频缓存表
   ```json
   {
     "_id": "自动生成",
     "text": "要转换的文本",
     "lang": "语言（ja/en/zh）",
     "voice": "声音类型",
     "audioUrl": "音频文件URL",
     "createTime": "创建时间",
     "openid": "用户openid"
   }
   ```

2. **user_words** - 用户学习记录
   ```json
   {
     "_id": "自动生成",
     "openid": "用户openid",
     "wordId": "单词ID", 
     "word": "单词内容",
     "status": "学习状态（mastered/fuzzy/forgot）",
     "reviewCount": "复习次数",
     "lastReviewTime": "最后复习时间",
     "nextReviewTime": "下次复习时间"
   }
   ```

#### 3.2 设置数据库权限

在云开发控制台 -> 数据库 -> 权限管理中设置：

- **audio_cache**: 仅创建者可读写
- **user_words**: 仅创建者可读写

### 4. 配置云存储

#### 4.1 创建存储桶

在云开发控制台 -> 云存储中创建文件夹：

- `audio/` - 存储生成的音频文件
- `images/` - 存储图片资源

#### 4.2 设置存储权限

- 所有用户可读
- 仅创建者可写

### 5. 环境变量配置（可选）

如需集成腾讯云TTS，在云函数中设置环境变量：

1. 在云开发控制台 -> 云函数中选择 `tts-service`
2. 点击 "配置" -> "环境变量"
3. 添加以下变量：
   ```
   TENCENT_SECRET_ID=你的SecretId
   TENCENT_SECRET_KEY=你的SecretKey
   ```

## 测试云函数

### 1. 在微信开发者工具中测试

1. 右键点击云函数
2. 选择 "本地调试"
3. 输入测试参数：
   ```json
   {
     "text": "こんにちは",
     "lang": "ja"
   }
   ```

### 2. 在小程序中测试

1. 运行小程序
2. 进入学习页面
3. 点击音频播放按钮
4. 查看控制台输出

## 预设音频配置

### 当前预设音频列表

```javascript
const PRESET_AUDIO_MAP = {
  'こんにちは': 'https://example.com/audio/konnichiwa.mp3',
  'ありがとう': 'https://example.com/audio/arigatou.mp3',
  'おはよう': 'https://example.com/audio/ohayou.mp3',
  // ... 更多
}
```

### 添加新的预设音频

1. 准备音频文件（MP3格式）
2. 上传到云存储的 `audio/` 目录
3. 在 `tts-service/index.js` 中添加映射关系
4. 重新部署云函数

## 音频播放策略

```
优先级：
1. MCP服务（开发环境）
2. 预设音频（云存储）
3. 数据库缓存
4. 腾讯云TTS生成
5. 显示读音信息（兜底）
```

## 监控和日志

### 查看云函数日志

1. 云开发控制台 -> 云函数
2. 选择对应函数
3. 点击 "日志" 查看执行记录

### 监控指标

- 函数调用次数
- 响应时间
- 错误率
- 资源使用情况

## 成本优化

### 1. 音频缓存策略

- 常用词汇使用预设音频
- 用户生成的音频缓存到数据库
- 定期清理旧缓存

### 2. 云函数优化

- 冷启动时间优化
- 内存配置合理化
- 并发控制

### 3. 存储优化

- 音频文件压缩
- CDN加速配置
- 过期文件清理

## 故障排除

### 常见问题

1. **云函数调用失败**
   - 检查函数是否部署成功
   - 检查权限配置
   - 查看函数日志

2. **音频播放失败**
   - 检查音频URL是否有效
   - 检查网络连接
   - 检查小程序域名配置

3. **数据库操作失败**
   - 检查集合是否存在
   - 检查权限设置
   - 检查数据格式

### 调试技巧

1. 使用云函数本地调试
2. 在控制台查看详细日志
3. 使用小程序调试面板监控网络请求